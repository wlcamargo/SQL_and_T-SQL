--Criar a tabela Dim_Calendario
CREATE TABLE  dCalendario(
  [DATA_VENDA] DATE PRIMARY KEY,
  [ANO] AS DATEPART(YEAR,[DATA_VENDA]),
  [MES] AS DATEPART(MONTH,[DATA_VENDA]),
  [DIA]  AS DATEPART(DAY,[DATA_VENDA]), 
  [DIA_ANO]  AS DATEPART(DAYOFYEAR,[DATA_VENDA]), 
  [TRIMESTRE] AS DATEPART(QUARTER,[DATA_VENDA]),
  [SEMANA_ANO]AS DATEPART(WK,[DATA_VENDA]),
  [MES_NOME] AS DATENAME(MONTH, [DATA_VENDA]),
  [DIA_NOME] AS DATENAME(WEEKDAY, [DATA_VENDA]),
  [MES_ANO] AS CONCAT(DATEPART(MONTH,[DATA_VENDA]),' - ',DATEPART(YEAR,[DATA_VENDA])),
  [NOME_MES_ANO] AS CONCAT(DATENAME(MONTH,[DATA_VENDA]),' - ',DATEPART(YEAR,[DATA_VENDA])),
  CLASS_MES_ANO AS 
  CASE
	WHEN MONTH([DATA_VENDA]) = 10 THEN CONCAT(DATEPART(YEAR,[DATA_VENDA]),DATEPART(MONTH,[DATA_VENDA]))
	WHEN MONTH(DATA_VENDA) = 11 THEN CONCAT(DATEPART(YEAR,DATA_VENDA),DATEPART(MONTH,[DATA_VENDA]))
	WHEN MONTH([DATA_VENDA]) = 12 THEN CONCAT(DATEPART(YEAR,DATA_VENDA),DATEPART(MONTH,[DATA_VENDA]))
	ELSE
		CONCAT(DATEPART(YEAR,DATA_VENDA),0,DATEPART(MONTH,DATA_VENDA))
  END
);

--POVOAR  Dim_Calendario
WITH DATAS (datamin,datamax) AS (

	SELECT MIN(datamin), MAX(datamax) FROM (
		SELECT MIN([DATA_VENDA]) AS datamin, MAX([DATA_VENDA]) AS datamax 
		FROM fVendas
		
	) RS

),
CALENDARIO AS ( 

    SELECT (SELECT datamin FROM DATAS) AS [Data], 1 AS [nivel] --Ponto Inicial
        
		UNION ALL
    
	SELECT DATEADD(DAY, 1, [Data]), [nivel] + 1 --Ponto Recursive
    FROM  CALENDARIO
    WHERE [Data] < (SELECT datamax FROM DATAS)  

)
INSERT INTO dCalendario(DATA_VENDA)
SELECT [Data] FROM CALENDARIO
OPTION (MAXRECURSION 0)
