WITH ANO_ANTERIOR AS(
SELECT
	DATEPART(YY,DATA_VENDA) AS ANO,
	DATEPART(MM,DATA_VENDA) AS MES,
	SUM(VAL_TOTAL) AS VAL_TOTAL
FROM
	fVendas
WHERE
	DATEPART(YY,DATA_VENDA) = DATEPART(YY,GETDATE())-2
GROUP BY
	DATEPART(YY,DATA_VENDA),
	DATEPART(MM,DATA_VENDA)
),
ANO_ATUAL AS (
SELECT
	DATEPART(YY,DATA_VENDA) AS ANO,
	DATEPART(MM,DATA_VENDA) AS MES,
	SUM(VAL_TOTAL) AS VAL_TOTAL
FROM
	fVendas
WHERE
	DATEPART(YY,DATA_VENDA) = DATEPART(YY,GETDATE())-1
GROUP BY
	DATEPART(YY,DATA_VENDA),
	DATEPART(MM,DATA_VENDA)
)
SELECT 
	AA.ANO,
	AA.MES,
	AA.VAL_TOTAL AS '2021',
	ANT.VAL_TOTAL AS '2020',
	((AA.VAL_TOTAL - ANT.VAL_TOTAL) / ANT.VAL_TOTAL)*100 AS LY

FROM
	ANO_ATUAL AA
	INNER JOIN ANO_ANTERIOR ANT
		ON AA.MES = ANT.MES
ORDER BY 
	1,2;
